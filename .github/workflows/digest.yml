name: Daily Digest

on:
  schedule:
    # Run daily at 6 AM UTC (adjust as needed)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI or website
    inputs:
      dry_run:
        description: 'Dry run (skip actual email sending)'
        required: false
        default: 'false'
        type: boolean
      categories:
        description: 'arXiv categories (comma-separated, e.g., cs.AI,cs.CL)'
        required: false
        type: string
      interests:
        description: 'Research interests for ranking'
        required: false
        type: string

permissions:
  contents: write

jobs:
  send-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages-site

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[anthropic]"

      - name: Restore digest state
        uses: actions/cache@v4
        with:
          path: .digest_state
          key: digest-state-${{ github.repository }}
          restore-keys: |
            digest-state-

      - name: Send digest
        env:
          # Required: Recipients
          DIGEST_RECIPIENTS: ${{ secrets.DIGEST_RECIPIENTS }}

          # Required: Content configuration (inputs override vars)
          DIGEST_CATEGORIES: ${{ inputs.categories || vars.DIGEST_CATEGORIES || 'cs.AI,cs.LG,cs.CL' }}
          DIGEST_INTERESTS: ${{ inputs.interests || vars.DIGEST_INTERESTS || 'machine learning, AI agents, large language models' }}

          # Optional: Email settings
          DIGEST_SUBJECT: ${{ vars.DIGEST_SUBJECT || 'Daily Research Digest - {date}' }}
          DIGEST_FROM: ${{ vars.DIGEST_FROM || 'noreply@example.com' }}
          DIGEST_TZ: ${{ vars.DIGEST_TZ || 'UTC' }}
          DIGEST_WINDOW: ${{ vars.DIGEST_WINDOW || '24h' }}

          # Optional: Digest settings
          DIGEST_MAX_PAPERS: ${{ vars.DIGEST_MAX_PAPERS || '50' }}
          DIGEST_TOP_N: ${{ vars.DIGEST_TOP_N || '10' }}

          # Required: SMTP configuration
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_TLS: ${{ vars.SMTP_TLS || 'true' }}

          # Required: LLM API key
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'anthropic' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

          # Save digest JSON for website
          DIGEST_SAVE_DIR: digests
        run: python -m daily_research_digest.digest_send

      - name: Commit digest files
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add digests/
          git diff --staged --quiet || git commit -m "Add digest for $(date +%Y-%m-%d)"
          git push

      - name: Save digest state
        uses: actions/cache/save@v4
        if: always()
        with:
          path: .digest_state
          key: digest-state-${{ github.repository }}-${{ github.run_id }}
